# LightSync 开发文档（优化版）

> 底层逻辑基于 OpenRGB；在其之上实现独立 Qt UI 与业务层。本文面向开发者，覆盖架构设计、目录规范、页面与组件规范、三大模式实现（内置/同屏/音乐）、数据模型、日志与性能、构建发布与测试策略。

---

## 1. 项目概览

* **核心目标**：

  * 统一管理与控制多品牌 RGB 设备（复用 OpenRGB 适配层）。
  * 提供现代化、可扩展的 UI 与交互：设备布局可拖拽、LED 编辑、颜色选择器、全局/设备亮度。
  * 三种模式：**内置模式**（调用 OpenRGB 内置效果）、**同屏模式**（屏幕采样）、**音乐模式**（音频频段驱动效果）。
* **技术栈**：Qt 5.15.x（Widgets）、C++17（按现有风格约束）、OpenRGB SDK/协议、FFmpeg/PortAudio（音乐模式可选）。
* **运行形态**：GUI / 无界面（`--nogui`）；单机 / 客户端-服务器（网络模式）。

---

## 2. 架构分层（高内聚 / 低耦合）

```
┌──────────────────────────────────────────────────────────┐
│                         UI 层（Qt Widgets）              │
│  Home / 设置 / 帮助 / 设备控制 / 布局器 / 弹窗组件       │
└──────────────▲───────────────────────────────────────────┘
               │ Qt signal/slot / EventBus（轻量）
┌──────────────┴───────────────────────────────────────────┐
│                       核心服务层                          │
│ DeviceService / EffectService / LayoutService             │
│ ScreenCaptureService / AudioCaptureService                │
│ MappingService / ProfileService / NetworkService          │
└──────────────▲───────────────────────────────────────────┘
               │ Adapter（DTO）
┌──────────────┴───────────────────────────────────────────┐
│                    OpenRGB 适配层（SDK/协议）             │
│  设备发现/能力/LED 通道/内置效果/传输                     │
└───────────────────────────────────────────────────────────┘
```

### 2.1 服务职责

* **DeviceService**：设备发现、启停、能力查询（亮度、分区、内置效果列表）、批量下发颜色帧。
* **EffectService**：抽象效果 `Effect` 接口；同屏/音乐等效果为实现类，内置模式做为 *代理* 到 OpenRGB 内置效果。
* **LayoutService**：设备/LED 的几何与逻辑布局（画布坐标、分组、层级、对齐、吸附、约束）。
* **ScreenCaptureService**：区域/多区域采样、FPS/质量/伽马、颜色校正。
* **AudioCaptureService**：音频源管理、FFT/能量谱计算、降噪/动态阈值、节拍检测（可选）。
* **MappingService**：把采样数据（像素/频段能量）映射到 LED（梯度、平均、加权、滚动窗口）。
* **ProfileService**：配置持久化/导入导出/版本迁移、会话恢复。
* **NetworkService**：客户端/服务器模式；帧压缩/速率控制；简单鉴权。

> 事件模型：UI 仅订阅服务层状态，所有写操作通过服务 API；服务间通过轻量事件总线或直接信号槽连接。

---

## 3. 目录结构（建议）

```
LightSync/
  app/                      # 入口、依赖注入、样式与资源
  ui/                       # Qt Widgets 界面与组件
    pages/
      HomePage/
      SettingsPage/
      HelpPage/
      DeviceControlPage/
      LayoutDesignerPage/
    widgets/
      LedEditorDialog/
      ColorPicker/
      BrightnessSlider/
      DeviceCard/
      MappingEditor/
  core/
    services/
      DeviceService/
      EffectService/
      LayoutService/
      ScreenCaptureService/
      AudioCaptureService/
      MappingService/
      ProfileService/
      NetworkService/
    models/                 # DTO/配置/枚举
    effects/                # 同屏/音乐/调色板等效果实现
  openrgb/                  # OpenRGB 适配与桥接
  profiles/                 # 默认配置与示例
  docs/
  build/
```

> 如有历史目录 `DeiceMap/` 建议统一为 `DeviceMap/` 或并入 `ui/pages/LayoutDesignerPage` 与 `core/services/LayoutService`，避免语义分散。

---

## 4. 数据模型（节选）

```cpp
enum class EffectMode { Builtin, ScreenSync, Music }; // 模式

struct LedNode {
    int device_id;   // 设备索引
    int led_index;   // 设备内 LED 序号
    int x, y;        // 画布坐标（像素或百分比）
    int w, h;        // 可选：命中区域大小
};

struct DeviceConfig {
    int device_id;
    int brightness;  // 0..100
    bool enabled;
    EffectMode mode;
};

struct ProfileConfig {
    int fps;           // 捕获/推送帧率
    int quality;       // 捕获质量
    bool gamma_correct;
    std::vector<DeviceConfig> devices;
};
```

> 所有模型遵循现有代码风格：变量 `snake_case`，类/函数 `CamelCase`，常量用 `#define`，日志统一 `LogManager`（详见日志章节）。

---

## 5. 页面与组件规范（UI）

### 5.1 首页（Home）

* **信息卡片**：设备总数、在线/离线、当前模式、目标 FPS。
* **快速操作**：一键开始/停止效果、切换模式、全局亮度滑条、配置一键保存/加载。
* **最近配置**：最近 5 个 `Profile`，双击应用。

### 5.2 设置页（Settings）

* **通用**：语言、主题、启动检查更新、日志等级、硬件加速开关。
* **性能**：捕获 FPS、质量、队列深度、批量传输大小、颜色校正、伽马。
* **同屏模式**：区域预设（全屏/四边/自定义）、多显示器选择、缩放与 DPI 处理。
* **音乐模式**：音频输入设备、采样率、窗口函数、频段分配方案、平滑与增益。
* **网络模式**：角色（客户端/服务器）、地址/端口、带宽上限、心跳与超时。
* **配置管理**：导入/导出、自动保存、启动加载 Default Profile。

### 5.3 帮助页（Help）

* **常见问题**、**日志位置**一键打开、**问题上报**入口。
* **快捷键**与**命令行**说明。

### 5.4 设备控制页（Device Control）

* 左侧设备列表（搜索/过滤/启用开关/模式选择）。
* 右侧详情：

  * 亮度/速度滑条、方向/缩放/偏移。
  * 区域映射编辑器（关联到 LayoutService）。
  * 「编辑 LED…」打开 **灯珠调弹窗**。

### 5.5 设备布局器（Layout Designer）

* **画布**：网格/吸附、缩放、对齐线、分组、层级。
* **交互**：拖拽设备卡/LED 区域、框选、对齐/等距分布、撤销/重做。
* **绑定**：为选中元素设置不同的效果/映射（例如把顶部边缘绑定到“顶部区域采样”）。
* **预览**：帧率/压力显示、采样热力图叠加。

### 5.6 灯珠调弹窗（LedEditorDialog）

* 批量/单个 LED：位置、旋转（可选）、色彩/淡入淡出、所属分组。
* 快捷：按设备外形自动铺排、按行列生成、从屏幕区域自动吸附。

### 5.7 颜色选择器（ColorPicker）

* H/S/V 与 R/G/B 数值输入、取色吸管（屏幕像素采样）、常用色与渐变预设。

### 5.8 亮度调节器（BrightnessSlider）

* 全局/单设备亮度；支持滚轮微调与键盘步进；支持「锁定最大亮度」以保护设备。

---

## 6. 模式实现

### 6.1 内置模式（Built‑in）

* **思路**：查询设备支持的**内置效果列表**，仅由 UI 触发选择与参数透传，数据面全部走 OpenRGB。
* **关键点**：

  * 设备可能能力不一致（参数/可用效果），需按设备维度下发。
  * UI 提供“按设备/按组/全局”三档应用方式。

### 6.2 同屏模式（Screen Sync）

* **数据流**：

  1. `ScreenCaptureService` 以设定 FPS/质量采样 →
  2. `MappingService` 将区域像素聚合为 LED 颜色 →
  3. `DeviceService` 批量下发颜色帧。
* **参数**：FPS、质量、区域集合、颜色校正、亮度、方向/缩放/偏移。
* **优化**：色域压缩、降采样、分块并行、帧跳过（Under Load 降级）、零拷贝共享内存（平台相关）。

### 6.3 音乐模式（Music）

* **信号链**：音频采样 → 窗口化（Hann）→ FFT → 频段功率（对数刻度）→ 平滑 → 频段到 LED 映射。
* **效果样式**：

  * **频段柱状**：低频→高频沿布局投射；能量→亮度/饱和度。
  * **节拍脉冲**：节拍检测触发全局脉冲/过渡。
  * **光谱流**：频谱作为渐变纹理沿设备路径滚动。
* **参数**：源设备、采样率、窗口大小、频段划分（例如 8/16/32）、增益、平滑半衰、底噪门限。

---

## 7. API 设计（示例）

```cpp
class Effect {
public:
    virtual ~Effect() {}
    virtual void Start() = 0;
    virtual void Stop() = 0;
    virtual void Tick() = 0; // 由调度器按 FPS 调用
};

class ScreenSyncEffect : public Effect {
public:
    void Start() override;
    void Stop() override;
    void Tick() override; // 抓帧→映射→下发
};

class MusicEffect : public Effect {
public:
    void Start() override;
    void Stop() override;
    void Tick() override; // 取样→FFT→映射→下发
};

class DeviceService {
public:
    void RefreshDevices();
    void SetBrightness(int device_id, int brightness);
    void SendFrame(const std::vector<uint32_t>& rgb);
};
```

> 核心循环由调度器根据目标 FPS 驱动；`Tick()` 内避免阻塞，长耗时任务拆分/并行。

---

## 8. 事件与信号槽（建议）

* `DeviceService`：`SignalDevicesChanged()`, `SignalDeviceUpdated(int device_id)`
* `EffectService`：`SignalEffectStarted(EffectMode)`, `SignalEffectStopped(EffectMode)`
* `ScreenCaptureService`：`SignalFrameReady(const Frame&)`
* `AudioCaptureService`：`SignalSpectrumReady(const Spectrum&)`
* `ProfileService`：`SignalProfileLoaded(const QString&)`

UI 仅订阅这些信号以刷新控件；写操作集中走服务。

---

## 9. 配置与持久化

* **格式**：JSON（兼容现有示例）；版本字段 `schema_version`，支持向前迁移。
* **路径**：用户数据目录下 `profiles/`；自动备份最近 N 份。
* **键位建议**：

```json
{
  "schema_version": 1,
  "app": {"language": "zh-CN", "theme": "dark"},
  "capture": {"fps": 60, "quality": 80, "gamma": true},
  "music": {"sample_rate": 48000, "bands": 16, "smoothing": 0.6},
  "devices": [
    {"id": 0, "enabled": true, "brightness": 80, "mode": "ScreenSync"}
  ],
  "layout": {"nodes": [{"device_id":0, "led_index":0, "x":120, "y":40}]}
}
```

---

## 10. 日志与调试

* 统一 `LogManager`：`LL_INFO/LL_WARNING/LL_ERROR/...`；所有模块只用该接口。
* 关键路径埋点：效果启动/停止、设备枚举、帧下发耗时、采样耗时、网络 RTT。
* GUI 弹窗级别使用 `LL_DIALOG`。

---

## 11. 性能与稳定性

* **降级策略**：帧率自适应、分辨率降采样、部分设备临时停用、色彩缓存复用。
* **并行**：捕获/映射/下发流水线化；使用环形缓冲避免抖动。
* **安全**：亮度上限保护、设备温度告警（可选）。

---

## 12. 网络模式（客户端/服务器）

* 服务器：维护订阅列表，按需广播颜色帧；带宽整形与压缩（RLE/Delta）。
* 客户端：与本地效果二选一（互斥）；心跳/重连；时钟漂移修正。
* 命令行对齐：`--client host:port` / `--server port`。

---

## 13. 构建与发布

* Qt 5.15.2 + 对应工具链；Qt Creator/`qmake`；提供 GUI/无界面构建配置。
* 产物：Windows 安装包（含依赖）、Linux AppImage/DEB、macOS .app。
* CI：编译 + 单元测试 + 签名 + 产物上传（GitHub Releases）。

---

## 14. 测试计划

* **单元**：Mapping、颜色校正、FFT 处理、配置读写。
* **集成**：屏幕采样→映射→下发端到端；多显示器；多设备并发。
* **回归**：模式切换后资源释放；网络断连恢复；高负载降级。

---

## 15. 国际化与可访问性

* `Qt Linguist` 工作流；新增/变更 UI 文本必须同步 `.ts`；构建前 `lrelease` 生成 `.qm`。
* 高对比度主题、键盘导航、可放大字体；图标附带可读标签（辅助功能）。

---

## 16. 代码风格（沿用现有规范，摘要）

* 变量 `snake_case`；类/函数 `CamelCase`；4 空格缩进；`if(TRUE)` 风格；常量 `#define` 且十六进制大写；优先 C 风格索引与强转；容器优先 `std::vector`/`std::string`；日志统一 `LogManager`。

---

## 17. 路线图

* [ ] 布局器支持对齐/等距/吸附与撤销栈。
* [ ] 音乐模式新增节拍驱动过渡与频段到渐变 LUT。
* [ ] 高性能路径：平台特定的 DMA/Zero‑copy 捕获（可选）。
* [ ] 插件体系：第三方效果动态加载。

---

## 18. 附录：典型流程

### 18.1 同屏模式主循环（伪码）

```
loop at target_fps:
  frame = ScreenCaptureService.Grab(region_set)
  colors = MappingService.Aggregate(frame, layout.nodes)
  DeviceService.SendFrame(colors)
```

### 18.2 音乐模式主循环（伪码）

```
loop at target_fps:
  audio = AudioCaptureService.Capture()
  spectrum = FFT(audio)
  colors = MapSpectrumToLeds(spectrum, layout/bands)
  DeviceService.SendFrame(colors)
```

---

**完成度建议**：先实现内置模式→同屏模式→音乐模式（三阶段），每阶段都包含：服务层 / UI / 配置 / 回归测试的闭环。
